name: kubectl-tap
on:
  push:
    # trigger on push to master
    branches: [master]
    # and on semver tag
    tags:
      - v*.*.*

jobs:
  build:
    timeout-minutes: 30
    name: Go build kubectl-tap
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.25'

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Add Go bin to PATH
      run: echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

    - name: Configure GOBIN and cache
      run: |
        echo "GOBIN=${{ github.workspace }}/.gobin" >> $GITHUB_ENV
        echo "${{ github.workspace }}/.gobin" >> $GITHUB_PATH

    - name: Restore GOBIN cache
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/.gobin
        key: ${{ runner.OS }}-gobin-${{ hashFiles('scripts/deps.sh') }}

    - name: Install system packages
      run: |
        sudo apt-get update
        sudo apt-get install -y zsh kubectl

    - name: Install developer tools
      run: make deps
      working-directory: ./

    - name: Generate code
      run: go generate ./...

    - name: Lint
      run: golangci-lint run --timeout 5m

    - name: Build
      run: go install -v -trimpath -ldflags="-s -w" ./cmd/kubectl-tap

    - name: Integration Test
      run: ./scripts/ig-test.zsh

  docker-build-scratch:
    timeout-minutes: 10
    name: gcr.io/soluble-oss/kubectl-tap:latest
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
    - 
      name: Build binary and push to GCR
      uses: docker/build-push-action@v6
      with:
        path: .
        dockerfile: Dockerfile
        username: _json_key
        password: ${{ secrets.SOLUBLE_GCR_OSS_JSON }}
        registry: gcr.io
        repository: soluble-oss/kubectl-tap
        tags: latest

  docker-build-alpine:
    timeout-minutes: 10
    name: gcr.io/soluble-oss/kubectl-tap:alpine
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
    - 
      name: Build binary and push to GCR
      uses: docker/build-push-action@v6
      with:
        path: .
        dockerfile: Dockerfile.alpine
        username: _json_key
        password: ${{ secrets.SOLUBLE_GCR_OSS_JSON }}
        registry: gcr.io
        repository: soluble-oss/kubectl-tap
        tags: alpine

  release:
    timeout-minutes: 15
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build, docker-build-scratch, docker-build-alpine]
    name: Release kubectl-tap
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Setup Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.25'

    - name: Install zsh
      run: sudo apt-get update; sudo apt-get install -y zsh
    - name: Fetch for goreleaser
      run: git fetch --prune

    - name: Build
      run: |
        go install -v -trimpath -ldflags="-s -w" ./cmd/kubectl-tap
    - 
      name: Release
      uses: goreleaser/goreleaser-action@v6.4.0
      with:
        version: v0.141.0
        args: release --rm-dist
      env:
        GITHUB_TOKEN: ${{ secrets.SOLUBLE_KUBETAP_BOT_TOKEN }}
    - 
      name: Update krew plugin
      if: "!contains(github.ref, '-')" # skip RCs
      uses: rajatjindal/krew-release-bot@v0.0.47
